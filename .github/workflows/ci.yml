name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    name: Run Pytest Test Suite
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f default/requirements.txt ]; then pip install -r default/requirements.txt; else pip install pytest; fi

      - name: Run pytest and generate report
        run: |
          pytest tests --maxfail=1 --disable-warnings --tb=short --junitxml=pytest-report.xml

      - name: Upload Pytest Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: pytest-report.xml

      - name: Troubleshooting Guide
        if: failure()
        run: |
          echo '::error::One or more tests failed. Please review the pytest-report.xml artifact for details.'
          echo 'Common issues:'
          echo '  - Missing dependencies: Check requirements.txt.'
          echo '  - Syntax errors in test files.'
          echo '  - Incorrect test discovery (tests should be in the tests/ directory).'

#
# Documentation:
# This workflow automatically runs all pytest test cases under the tests/ directory on every push and pull request to main.
#
# - Python 3.10 is set up on the runner.
# - Dependencies are installed from default/requirements.txt if present; otherwise, pytest is installed directly.
# - Pytest runs with minimal output and a JUnit XML report is generated and uploaded as an artifact.
# - If any test fails, the workflow fails and a troubleshooting guide is printed.
# - No source or test files are modified by this workflow.
#
# Optimization/Scalability Recommendations:
# - For large projects, consider parallelizing test execution using matrix strategies.
# - Integrate coverage reporting (e.g., codecov) for deeper insights.
# - Add caching for dependencies to speed up builds.
# - Use secrets and environment variables for secure deployments.
#
