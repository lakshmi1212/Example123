# =====================================================
# CI Pipeline for Python Project (Pytest Integration)
# -----------------------------------------------------
# This workflow automatically runs all pytest test cases
# under the 'tests' directory on every push or pull request
# targeting the 'main' branch.
#
# Key Features:
# - Python 3.10 environment setup
# - Dependency installation from requirements.txt
# - Pytest execution with error handling
# - Fails pipeline if any test fails
# - Generates summary and artifact for test results
# =====================================================

name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Pytest Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f default/requirements.txt ]; then pip install -r default/requirements.txt; else pip install pytest; fi

      - name: Run pytest and generate report
        run: |
          mkdir -p test-results
          pytest tests --junitxml=test-results/results.xml
        continue-on-error: false

      - name: Upload Pytest results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: test-results/results.xml

      - name: Display test summary
        if: always()
        run: |
          if [ -f test-results/results.xml ]; then
            echo "Test results XML found."
            head -n 20 test-results/results.xml || true
          else
            echo "No test results found."
          fi

# =====================================================
# Documentation:
# - This workflow is triggered on push and pull_request events to 'main'.
# - It sets up Python 3.10 and installs dependencies (pytest).
# - All tests in the 'tests' directory are executed using pytest.
# - The workflow fails if any test fails (exit code != 0).
# - Pytest results are uploaded as an artifact for further inspection.
#
# Troubleshooting:
# - If the workflow fails at dependency installation, check requirements.txt format.
# - If tests are not discovered, ensure they are named 'test_*.py' and are in the 'tests' directory.
# - Inspect 'pytest-results' artifact for detailed test output.
#
# Recommendations for Optimization & Scalability:
# - Add caching for pip dependencies to speed up builds.
# - Integrate code coverage reporting (e.g., pytest-cov, Codecov).
# - Add additional jobs for linting, security scanning, or multi-version testing.
# =====================================================
