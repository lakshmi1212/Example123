# ------------------------------------------------------------
# CI Pipeline: Automated Python Testing with pytest
#
# This workflow runs all pytest tests in the 'tests' directory on:
#   - Pushes to the main branch
#   - Pull requests targeting the main branch
#
# Features:
#   - Python 3.10 environment
#   - Dependency installation from requirements.txt
#   - Fails pipeline if any test fails
#   - Detailed error reporting in GitHub Actions UI
#   - Troubleshooting and optimization guidance in comments
# ------------------------------------------------------------

name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Python Tests (pytest)
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Python 3.10
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install pytest; fi

      # Step 4: Run pytest on all tests in the tests directory
      - name: Run tests with pytest
        run: pytest tests --maxfail=5 --disable-warnings --tb=short

      # Step 5: Upload pytest results as artifact (for further analysis)
      - name: Upload pytest results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pytest-results
          path: .pytest_cache/

    # Error handling: GitHub Actions automatically fails the job if pytest returns non-zero exit code.
    # Additional troubleshooting tips are provided below.

# ------------------------------------------------------------
# Documentation & Troubleshooting
# ------------------------------------------------------------
# - All code and test changes pushed to 'main' or via PRs to 'main' will trigger this workflow.
# - The workflow installs dependencies from requirements.txt if present, otherwise installs pytest directly.
# - If any test fails, the pipeline fails and error details are shown in the Actions UI.
# - Test output and cache are uploaded as artifacts for inspection.
#
# Troubleshooting Common Issues:
# - Ensure all tests are in the 'tests' directory and named 'test_*.py'.
# - If dependencies are missing, add them to requirements.txt.
# - For verbose pytest output, add '-v' to the pytest command.
# - For debugging, use 'Run tests with pytest' step logs in the Actions UI.
#
# Recommendations for Optimization & Scalability:
# - Use a requirements-dev.txt for test-only dependencies.
# - Add coverage reporting with pytest-cov and upload as artifact.
# - For large projects, split tests across multiple jobs/matrix builds.
# - Integrate code quality tools (e.g., flake8, black) as additional steps.
# - Use caching for pip dependencies to speed up installs (actions/cache).
# ------------------------------------------------------------
